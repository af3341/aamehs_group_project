---
title: "Nonlinear Regression and PCA Results Outline"
output: html_document
author: "Allison Stewart, Christine Kuryla, Zander De Jesus, Alana Ferris"
date: "2024-03-24"
---

These are preliminary analyses for non-linear regression of phthalate metabolites on AGP concentration and PCA of phthalate metabolites in children aged 3-16 years old. 

For non-linear regression, we ran GAM models with penalized splines for each metabolite that had an effective degrees of freedom greater than 1. We also ran a multiple regression model with the same metabolites and covariates to see if the metabolites were still significant predictors of AGP concentration when adjusting for demographic variables. 

Moving forward, should we include all the metabolites together in one model or run separate models for each metabolite? (there are 19 different metabolite alternatives) We're thinking of including the 8 metabolites that had edf > 1 with splines in the final model and those with edf = 1 with no spline. Does this make sense? 

```{r setup, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(foreign)
library(dplyr)
library(mgcv)
library(splines)
library(gridExtra)
```

```{r message=FALSE, warning=FALSE, echo = FALSE}
### Reading in Relevant NHANES 2017-2018 Data
#NOTE: phthalate and AGP data have special sample weights we need to account for in analysis
#weighting module: https://wwwn.cdc.gov/nchs/nhanes/tutorials/Weighting.aspx

# phthalates and plasticizers metabolites - urine 
# codebook, LODs: https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/PHTHTE_J.htm
phthte_urine =
  read.xport("data/PHTHTE_J.XPT") %>% 
  janitor::clean_names()

# urine creatinine levels 
# codebook: https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/ALB_CR_J.htm
creatinine_urine =
  read.xport("data/ALB_CR_J.XPT") %>% 
  janitor::clean_names()

# Alpha-1-Acid Glycoprotein - Serum
# codebook: https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/SSAGP_J.htm
agp_serum =
  read.xport("data/SSAGP_J.XPT") %>% 
  janitor::clean_names()

# Demographic variables and sample weights 
# codebook: https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/DEMO_J.htm
demo =
  read.xport("data/DEMO_J.XPT") |> 
  janitor::clean_names()
```

```{r message=FALSE, warning=FALSE, echo = FALSE}
# Cleaning Variable Names of Phthalate Urine Data 

phthte_urine =
  phthte_urine %>% 
  rename(weights = wtsb2yr) %>%
  rename_with(~ gsub("^urx", "", .), starts_with("urx")) %>% 
  filter(!weights == "0")
```

```{r message=FALSE, warning=FALSE, echo = FALSE}
# Adjusting Phthalate Urine Data for Creatinine

# merging Phthalate urine data with urinary creatinine levels and then adjusting concentrations for creatinine
# dropping albumin from creatinine dataset
creatinine_urine =
  creatinine_urine %>% 
  select(seqn, urxucr, urducrlc) #dropping urxcrs bc i dont want creatinine expressed in those units
#7936 obs

#merging creatinine data with phthalate data
phthte_creatinine =
  merge(creatinine_urine, phthte_urine, by = "seqn") %>%
  select(!starts_with("urd")) %>% #dropped <LOD columns for ease of pivoting
  pivot_longer(cols = cnp:mzp,  
               names_to = "analyte_code",
               values_to = "reported_result") #pivoted longer so that i can map in the next step

#54169 obs 

#urinary [phth] in ng/mL
# urinary [creatinine] in mg/dL so need to get this to ng/mL

# Urinary creatinine concentrations, specific gravity, and osmolality are common methods for adjusting dilution. The most widely used method is creatinine adjustment that involves dividing the analyte concentration by the creatinine concentration. Analyte results are then reported as weight of analyte per gram of creatinine (micrograms analyte per gram creatinine).

# making a new column with creatinine-adjusted [phthalate]
phthte_creatinine =
  phthte_creatinine %>% 
  mutate(ng_per_ml_creatinine = urxucr*10000) %>% #here converting mg/dL to ng/mL--> 1mg/dL = 10,000ng/mL
  mutate(adj_conc = reported_result/ng_per_ml_creatinine)
```

```{r message=FALSE, warning=FALSE, echo = FALSE}
# Cleaning Variable Names of Demographic Data

# drop unneeded variables from dataset 
demo <- subset(demo, select = -c(sddsrvyr, ridstatr, ridexprg, dmdmartl, dmdeduc2, dmqmiliz, dmqadfc, dmdhrgnd, dmdhragz, dmdhredz, dmdhrmaz, dmdhsedz))

demo <- demo |> 
  rename(gender = riagendr, 
         age_yrs_screen = ridageyr, 
         age_mon_screen = ridagemn, 
         race_ethn1 = ridreth1,
         race_ethn3 = ridreth3, 
         time_period = ridexmon, 
         age_mon_screen = ridagemn,
         age_mon_exam = ridexagm, 
         birth_country = dmdborn4, 
         citizenship = dmdcitzn,
         years_us = dmdyrsus, 
         education = dmdeduc3, 
         lang_pers_quest = sialang, 
         proxy_pers_quest = siaproxy, 
         interpret_pers_quest = siaintrp, 
         lang_fam_interview = fialang, 
         proxy_fam_interview = fiaproxy, 
         interpret_fam_interview = fiaintrp,
         lang_capi = mialang, 
         proxy_capi = miaproxy, 
         interpret_capi = miaintrp, 
         lang_acasi = aialanga, 
         hh_size = dmdhhsiz, 
         fam_size = dmdfmsiz, 
         hh_young_children = dmdhhsza,
         hh_children = dmdhhszb, 
         hh_adults = dmdhhsze, 
         weight_2yr_intervew = wtint2yr,
         weight_2yr_mec = wtmec2yr, 
         variance_psu = sdmvpsu, 
         variance_stratum = sdmvstra, 
         income_hh_annual = indhhin2, 
         income_family_annual = indfmin2, 
         income_poverty_ratio = indfmpir)
```

```{r message=FALSE, warning=FALSE, echo = FALSE}
# Subsetting Demographic Data to Ages 3-16 

demo <- demo |> 
  filter(age_yrs_screen >= 3 & age_yrs_screen <= 16)
```

```{r message=FALSE, warning=FALSE, echo = FALSE}
#Joining demographic, phthalate, and agp data

#making phthalate adjusted with creatinine dataset wide so can join with demo data
wide_phth_creat =
  phthte_creatinine %>%
  select(-reported_result, -ng_per_ml_creatinine) %>% 
  pivot_wider(names_from = "analyte_code",
              values_from = "adj_conc") 
#noticed that participant #93739, 93771, has no data for any of the pththalate metabolites, even in phthte_urine dataset, so should drop them from further analysis?
# there are many participants with no values for any of them , even in phthte_urine dataset 
# went back to checkin_feb_20_deliverable to get rid of them there 


all_data =
  inner_join(demo, wide_phth_creat, by = "seqn") #915 people with demo and phthalate data


exp_outcome =
  inner_join(wide_phth_creat, agp_serum, by = "seqn") %>% 
  filter(!is.na(ssagp)) #662 participants that provided agp samples and have phthalate data for 
  
summary(exp_outcome)
(292/954)*100
```

```{r Demographic Covariate Model, linear regression, message=FALSE, warning=FALSE}
#Joining current demographic values we have with the exp_outcome table

demo_new = demo |> 
  select(seqn, gender, age_yrs_screen, race_ethn3, income_family_annual)

all_exp_outcome = inner_join(exp_outcome, demo_new, by = "seqn") |> 
  mutate(gender_female = if_else(gender == 1, 1, 0)) |>  #making a binary assignment of gender for multiple regression male = 0, female = 1
  mutate(eth_mex = case_when(race_ethn3 == 1 ~ 1, TRUE ~ 0),
         eth_hisp_oth = case_when(race_ethn3 == 2 ~ 1, TRUE ~ 0),
         eth_white = case_when(race_ethn3 == 3 ~ 1, TRUE ~ 0),
         eth_black = case_when(race_ethn3 == 4 ~ 1, TRUE ~ 0),
         eth_asian = case_when(race_ethn3 == 6 ~ 1, TRUE ~ 0),
         eth_nonhispanic_multirace = case_when(race_ethn3 == 7 ~ 1, TRUE ~ 0)) 

all_exp_outcome$gender_female <- as.factor(all_exp_outcome$gender_female)
all_exp_outcome$race_ethn3 <- as.factor(all_exp_outcome$race_ethn3)

#Associations of demo variables alone
demographic_model = lm(ssagp ~ gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

summary(demographic_model)

#Adding covariates to simple multiple regression 
lin_covari_model = lm(ssagp ~ cnp + cop + ecp + ecpt + hibp + mbp + mc1 + mcoh + mep + mhbp + mhh + mhht + mhnc + mhp + mib + mnp + moh + monp + mzp + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

summary(lin_covari_model)

#Old version 
lin_covari_model2 = lm(ssagp ~ cnp + cop + ecp + ecpt + hibp + mbp + mc1 + mcoh + mep + mhbp + mhh + mhht + mhnc + mhp + mib + mnp + moh + monp + mzp + gender_female + age_yrs_screen + income_family_annual + eth_mex + eth_hisp_oth + eth_black + eth_asian + eth_nonhispanic_multirace, data = all_exp_outcome)

summary(lin_covari_model2)
```

Using this initial list of covariates, we do not currently have enough evidence to suggest a statistically significant difference in ssagp differing across ethnic groups, gender, or income poverty ratio. Under these adjusted assumptions, both mcoh and mhnc are the metabolites tht have the most significant impact on ssagp.

# Non-linear exposure-response curves 
```{r message=FALSE, warning=FALSE}
#metabolites: cnp, cop, ecp, ecpt, hipb, mbp, mc1, mcoh, mep, mhbp, mhh, mhht, mhnc, mhp, mib, mnp, moh, monp, mzp

#first fit linear model 

lin_covari_model = lm(ssagp ~ cnp + cop + ecp + ecpt + hibp + mbp + mc1 + mcoh + mep + mhbp + mhh + mhht + mhnc + mhp + mib + mnp + moh + monp + mzp + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

summary(lin_covari_model)

#fit complete model with penalized splines 

total_model <- gam(ssagp  ~ s(cnp) + s(cop) + s(ecp) + s(ecpt) + s(hibp) + s(mbp) + s(mc1) + s(mcoh) + s(mep) + s(mhbp) + s(mhh) + s(mhht) + s(mhnc) + s(mhp) + s(mib) + s(mnp) + s(moh) + s(monp) + s(mzp) + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

summary(total_model)

#edf not equal to 1 for ecpt, mcoh, mep, mhh, mhht, mhnc, mib, mzp
#going to fit GAM models with penalized splines for those 8 metabolites
```

### Indidual penalized splines for each metabolite with edf > 1 

```{r ecpt model, message=FALSE, warning=FALSE}
# Fit GAM model for ecpt with penalized spline 
ecpt_model <- gam(ssagp ~ s(ecpt) + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

# Generate predictions and standard errors
pred_ecpt <- predict(ecpt_model, se.fit = TRUE)

# Create dataframe for predictions and standard errors
pred_ecpt_df <- data.frame(
  pred_centered = pred_ecpt$fit,
  se = pred_ecpt$se.fit,
  lci_centered = pred_ecpt$fit - 1.96 * pred_ecpt$se.fit,
  uci_centered = pred_ecpt$fit + 1.96 * pred_ecpt$se.fit
)

#exclude missing values from original dataset and bind two datasets 
all_exp_outcome <- all_exp_outcome[complete.cases(all_exp_outcome), ]

# Combine predictions and original dataset
pred_ecpt_df <- cbind(all_exp_outcome, pred_ecpt_df)|> 
  mutate(metabolite_model = "ecpt")

# Uncenter data
pred_ecpt_df$pred_agp <- pred_ecpt_df$pred_centered + mean(all_exp_outcome$ssagp)
pred_ecpt_df$lci_agp <- pred_ecpt_df$lci_centered + mean(all_exp_outcome$ssagp)
pred_ecpt_df$uci_agp <- pred_ecpt_df$uci_centered + mean(all_exp_outcome$ssagp)

# Plot
ecpt_s <- ggplot(pred_ecpt_df, aes(x = ecpt, y = pred_agp)) + 
  geom_line() + 
  geom_ribbon(aes(ymin = lci_agp, ymax = uci_agp), fill = "grey", alpha = 0.5) + 
  xlab("MECPTP (g/L)") + 
  ylab("AGP (ng/mL)") 
```

```{r mcoh model, message=FALSE, warning=FALSE, echo = FALSE}
# Fit GAM model for mcoh with penalized spline 
mcoh_model <- gam(ssagp ~ s(mcoh) + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

# Generate predictions and standard errors
pred_mcoh <- predict(mcoh_model, se.fit = TRUE)

# Create dataframe for predictions and standard errors
pred_mcoh_df <- data.frame(
  pred_centered = pred_mcoh$fit,
  se = pred_mcoh$se.fit,
  lci_centered = pred_mcoh$fit - 1.96 * pred_mcoh$se.fit,
  uci_centered = pred_mcoh$fit + 1.96 * pred_mcoh$se.fit
)

#exclude missing values from original dataset and bind two datasets 
all_exp_outcome <- all_exp_outcome[complete.cases(all_exp_outcome), ]

# Combine predictions and original dataset
pred_mcoh_df <- cbind(all_exp_outcome, pred_mcoh_df)|> 
  mutate(metabolite_model = "mcoh")

# Uncenter data
pred_mcoh_df$pred_agp <- pred_mcoh_df$pred_centered + mean(all_exp_outcome$ssagp)
pred_mcoh_df$lci_agp <- pred_mcoh_df$lci_centered + mean(all_exp_outcome$ssagp)
pred_mcoh_df$uci_agp <- pred_mcoh_df$uci_centered + mean(all_exp_outcome$ssagp)

# Plot
mcoh_s <- ggplot(pred_mcoh_df, aes(x = mcoh, y = pred_agp)) + 
  geom_line() + 
  geom_ribbon(aes(ymin = lci_agp, ymax = uci_agp), fill = "grey", alpha = 0.5) + 
  xlab("MHNCH (g/L)") + 
  ylab("AGP (ng/mL)") 
```

```{r mep model, message=FALSE, warning=FALSE, echo = FALSE}
# Fit GAM model for mep with penalized spline 
mep_model <- gam(ssagp ~ s(mep) + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

# Generate predictions and standard errors
pred_mep <- predict(mep_model, se.fit = TRUE)

# Create dataframe for predictions and standard errors
pred_mep_df <- data.frame(
  pred_centered = pred_mep$fit,
  se = pred_mep$se.fit,
  lci_centered = pred_mep$fit - 1.96 * pred_mep$se.fit,
  uci_centered = pred_mep$fit + 1.96 * pred_mep$se.fit
)

#exclude missing values from original dataset and bind two datasets 
all_exp_outcome <- all_exp_outcome[complete.cases(all_exp_outcome), ]

# Combine predictions and original dataset
pred_mep_df <- cbind(all_exp_outcome, pred_mep_df) |> 
  mutate(metabolite_model = "mep")

# Uncenter data
pred_mep_df$pred_agp <- pred_mep_df$pred_centered + mean(all_exp_outcome$ssagp)
pred_mep_df$lci_agp <- pred_mep_df$lci_centered + mean(all_exp_outcome$ssagp)
pred_mep_df$uci_agp <- pred_mep_df$uci_centered + mean(all_exp_outcome$ssagp)

# Plot
mep_s <- ggplot(pred_mep_df, aes(x = mep, y = pred_agp)) + 
  geom_line() + 
  geom_ribbon(aes(ymin = lci_agp, ymax = uci_agp), fill = "grey", alpha = 0.5) + 
  xlab("MEP (g/L)") + 
  ylab("AGP (ng/mL)")
```

The mhht model below is likely not showing any reportable data due to the increasingly wide confidence interval at higher levels of metabolite concentration
```{r mhht model, message=FALSE, warning=FALSE, echo = FALSE}
# Fit GAM model for mhht with penalized spline 
mhht_model <- gam(ssagp ~ s(mhht) + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

# Generate predictions and standard errors
pred_mhht <- predict(mhht_model, se.fit = TRUE)

# Create dataframe for predictions and standard errors
pred_mhht_df <- data.frame(
  pred_centered = pred_mhht$fit,
  se = pred_mhht$se.fit,
  lci_centered = pred_mhht$fit - 1.96 * pred_mhht$se.fit,
  uci_centered = pred_mhht$fit + 1.96 * pred_mhht$se.fit
)


# Combine predictions and original dataset
pred_mhht_df <- cbind(all_exp_outcome, pred_mhht_df) |> 
  mutate(metabolite_model = "mhht")

# Uncenter data
pred_mhht_df$pred_agp <- pred_mhht_df$pred_centered + mean(all_exp_outcome$ssagp)
pred_mhht_df$lci_agp <- pred_mhht_df$lci_centered + mean(all_exp_outcome$ssagp)
pred_mhht_df$uci_agp <- pred_mhht_df$uci_centered + mean(all_exp_outcome$ssagp)

# Plot
mhht_s <- ggplot(pred_mhht_df, aes(x = mhht, y = pred_agp)) + 
  geom_line() + 
  geom_ribbon(aes(ymin = lci_agp, ymax = uci_agp), fill = "grey", alpha = 0.5) + 
  xlab("MEHHTP (g/L)") + 
  ylab("AGP (ng/mL)")
```

```{r mhht model, message=FALSE, warning=FALSE, echo = FALSE}
# Fit GAM model for mib with penalized spline 
mib_model <- gam(ssagp ~ s(mib) + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

# Generate predictions and standard errors
pred_mib <- predict(mib_model, se.fit = TRUE)

# Create dataframe for predictions and standard errors
pred_mib_df <- data.frame(
  pred_centered = pred_mib$fit,
  se = pred_mib$se.fit,
  lci_centered = pred_mib$fit - 1.96 * pred_mib$se.fit,
  uci_centered = pred_mib$fit + 1.96 * pred_mib$se.fit
)


# Combine predictions and original dataset
pred_mib_df <- cbind(all_exp_outcome, pred_mib_df) |> 
  mutate(metabolite_model = "mib")

# Uncenter data
pred_mib_df$pred_agp <- pred_mib_df$pred_centered + mean(all_exp_outcome$ssagp)
pred_mib_df$lci_agp <- pred_mib_df$lci_centered + mean(all_exp_outcome$ssagp)
pred_mib_df$uci_agp <- pred_mib_df$uci_centered + mean(all_exp_outcome$ssagp)

# Plot
mib_s <- ggplot(pred_mib_df, aes(x = mib, y = pred_agp)) + 
  geom_line() + 
  geom_ribbon(aes(ymin = lci_agp, ymax = uci_agp), fill = "grey", alpha = 0.5) + 
  xlab("MiBP (g/L)") + 
  ylab("AGP (ng/mL)")
```

```{r mhnc model, message=FALSE, warning=FALSE, echo = FALSE}
# Fit GAM model for mhnc with penalized spline 
mhnc_model <- gam(ssagp ~ s(mhnc) + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

# Generate predictions and standard errors
pred_mhnc <- predict(mhnc_model, se.fit = TRUE)

# Create dataframe for predictions and standard errors
pred_mhnc_df <- data.frame(
  pred_centered = pred_mhnc$fit,
  se = pred_mhnc$se.fit,
  lci_centered = pred_mhnc$fit - 1.96 * pred_mhnc$se.fit,
  uci_centered = pred_mhnc$fit + 1.96 * pred_mhnc$se.fit
)

# Combine predictions and original dataset
pred_mhnc_df <- cbind(all_exp_outcome, pred_mhnc_df)|> 
  mutate(metabolite_model = "mhnc")

# Uncenter data
pred_mhnc_df$pred_agp <- pred_mhnc_df$pred_centered + mean(all_exp_outcome$ssagp)
pred_mhnc_df$lci_agp <- pred_mhnc_df$lci_centered + mean(all_exp_outcome$ssagp)
pred_mhnc_df$uci_agp <- pred_mhnc_df$uci_centered + mean(all_exp_outcome$ssagp)

# Plot
mhnc_s <- ggplot(pred_mhnc_df, aes(x = mhnc, y = pred_agp)) + 
  geom_line() + 
  geom_ribbon(aes(ymin = lci_agp, ymax = uci_agp), fill = "grey", alpha = 0.5) + 
  xlab("MHNCH (g/L)") + 
  ylab("AGP (ng/mL)")
```

This one also has an extremely wide confidence interval at larger values
```{r mhp model, message=FALSE, warning=FALSE, echo = FALSE}
# Fit GAM model for mhh with penalized spline 
mhh_model <- gam(ssagp ~ s(mhh) + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

# Generate predictions and standard errors
pred_mhh <- predict(mhh_model, se.fit = TRUE)

# Create dataframe for predictions and standard errors
pred_mhh_df <- data.frame(
  pred_centered = pred_mhh$fit,
  se = pred_mhh$se.fit,
  lci_centered = pred_mhh$fit - 1.96 * pred_mhh$se.fit,
  uci_centered = pred_mhh$fit + 1.96 * pred_mhh$se.fit
)


# Combine predictions and original dataset
pred_mhh_df <- cbind(all_exp_outcome, pred_mhh_df) |> 
  mutate(metabolite_model = "mhh")

# Uncenter data
pred_mhh_df$pred_agp <- pred_mhh_df$pred_centered + mean(all_exp_outcome$ssagp)
pred_mhh_df$lci_agp <- pred_mhh_df$lci_centered + mean(all_exp_outcome$ssagp)
pred_mhh_df$uci_agp <- pred_mhh_df$uci_centered + mean(all_exp_outcome$ssagp)

# Plot
mhh_s <- ggplot(pred_mhh_df, aes(x =mhh, y = pred_agp)) + 
  geom_line() + 
  geom_ribbon(aes(ymin = lci_agp, ymax = uci_agp), fill = "grey", alpha = 0.5) + 
  xlab("MEHHP (g/L)") + 
  ylab("AGP (ng/mL)")
```

Another situation with very wide confidence intervals at higher metabolite concentrations
```{r mzp model, message=FALSE, warning=FALSE, echo = FALSE}
# Fit GAM model for mzp with penalized spline 
mzp_model <- gam(ssagp ~ s(mzp) + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

# Generate predictions and standard errors
pred_mzp <- predict(mzp_model, se.fit = TRUE)

# Create dataframe for predictions and standard errors
pred_mzp_df <- data.frame(
  pred_centered = pred_mzp$fit,
  se = pred_mzp$se.fit,
  lci_centered = pred_mzp$fit - 1.96 * pred_mzp$se.fit,
  uci_centered = pred_mzp$fit + 1.96 * pred_mzp$se.fit
)


# Combine predictions and original dataset
pred_mzp_df <- cbind(all_exp_outcome, pred_mzp_df) |> 
  mutate(metabolite_model = "mzp")

# Uncenter data
pred_mzp_df$pred_agp <- pred_mzp_df$pred_centered + mean(all_exp_outcome$ssagp)
pred_mzp_df$lci_agp <- pred_mzp_df$lci_centered + mean(all_exp_outcome$ssagp)
pred_mzp_df$uci_agp <- pred_mzp_df$uci_centered + mean(all_exp_outcome$ssagp)

# Plot
mzp_s <- ggplot(pred_mzp_df, aes(x =mzp, y = pred_agp)) + 
  geom_line() + 
  geom_ribbon(aes(ymin = lci_agp, ymax = uci_agp), fill = "grey", alpha = 0.5) + 
  xlab("MBzP (g/L)") + 
  ylab("AGP (ng/mL)")
```

```{r}
#Combine all plots
combined_plots_splines <- grid.arrange(ecpt_s, mcoh_s, mep_s, mhht_s, mib_s, mhnc_s, mhh_s, mzp_s, ncol = 3, top = "Non-Linear Models of Metabolite Exposure-Response Curves with Penalized Splines")

#save plot as png
ggsave("combined_plots_splines.png", combined_plots_splines, width = 12, height = 8)
```


**Returning to Total Model with Penalized Splines, adding covariates above**
```{r Adding Covariates to Penalized Spline Regression using GAM}
total_covari_model <- gam(ssagp  ~ s(cnp) + s(cop) + s(ecp) + s(ecpt) + s(hibp) + s(mbp) + s(mc1) + s(mcoh) + s(mep) + s(mhbp) + s(mhh) + s(mhht) + s(mhnc) + s(mhp) + s(mib) + s(mnp) + s(moh) + s(monp) + s(mzp) + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

summary(total_covari_model)

```
In this model, there are greater differences between children's ethnicities and ssagp concentration, where Mexican American children are having a significant per unit increase in ssagp concentration for adjusted phthalate metabolite exposure.

## Natural Splines 

```{r Natural Splines, message=FALSE, warning=FALSE}
#Fit natural splines for metabolites with edf not equal to 1 - ecpt, mcoh, mep, mhh, mhht, mhnc, mib, mzp

# Fit lm model for ecpt with natural spline
ecpt_ns_2 <- lm(ssagp ~ ns(ecpt, df = 2) + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)
ecpt_ns_3 <- lm(ssagp ~ ns(ecpt, df = 3) + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)
ecpt_ns_4 <- lm(ssagp ~ ns(ecpt, df = 4) + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)
ecpt_ns_5 <- lm(ssagp ~ ns(ecpt, df = 5) + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

AIC(ecpt_ns_2)
AIC(ecpt_ns_3)
AIC(ecpt_ns_4)
AIC(ecpt_ns_5)


summary(ecpt_ns_4)

# model with df 4 has the lowest AIC 

# construct predictions based on model 
predagp.ecpt.ns <- predict(ecpt_ns_4, se.fit = TRUE, type = "terms")

head(predagp.ecpt.ns)

# convert to dataframe 

predagp.ecpt.ns <- as.data.frame(predagp.ecpt.ns)

# Rename predictions and standard errors

predagp.ecpt.ns  <- predagp.ecpt.ns |> 
  mutate( pred.centered = fit.ns.ecpt..df...4.,
          se = se.fit.ns.ecpt..df...4.)

# 6c.iv Compute 95% confidence intervals 

predagp.ecpt.ns <- predagp.ecpt.ns |>  
  mutate( lci.centered = pred.centered - 1.96*se,
          uci.centered = pred.centered + 1.96*se)

# Keep only variables we need

predagp.ecpt.ns <- predagp.ecpt.ns |> 
  select(pred.centered, se, lci.centered, uci.centered)

# Combine with data 

predagp.ecpt.ns <- predagp.ecpt.ns |> bind_cols(all_exp_outcome)

#  Uncenter 

predagp.ecpt.ns <- predagp.ecpt.ns |>  mutate(predagp = pred.centered + mean(ssagp),
                                        lciagp = lci.centered + mean(ssagp),
                                        uciagp = uci.centered + mean(ssagp))

# Plot

ggplot(predagp.ecpt.ns, aes(ssagp)) + 
  geom_line(aes(y = predagp)) + 
  geom_line(aes(y = lciagp), color = "darkgrey") + 
  geom_line(aes(y = uciagp), color = "darkgrey") + 
  xlab(expression("Average AGP")) + 
  ylab("Predicted AGP (95% CI)") + 
  theme(axis.text = element_text(size = 15)) + 
  theme(axis.title = element_text(size = 20))
```

```{r}

# Fit lm model for moh with natural spline
moh_ns_2 <- lm(ssagp ~ ns(moh, df = 2) + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)
moh_ns_3 <- lm(ssagp ~ ns(moh, df = 3) + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)
moh_ns_4 <- lm(ssagp ~ ns(moh, df = 4) + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)
moh_ns_5 <- lm(ssagp ~ ns(moh, df = 5) + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

AIC(moh_ns_2)
AIC(moh_ns_3)
AIC(moh_ns_4)
AIC(moh_ns_5)


# construct predictions based on model 
predagp.moh.ns <- predict(moh_ns_2, se.fit = TRUE, type = "terms")

# convert to dataframe 

predagp.moh.ns <- as.data.frame(predagp.moh.ns)

# Rename predictions and standard errors

predagp.moh.ns  <- predagp.moh.ns |> 
  mutate( pred.centered = fit.ns.moh..df...2.,
          se = se.fit.ns.moh..df...2.)

# 6c.iv Compute 95% confidence intervals 

predagp.moh.ns <- predagp.moh.ns |>  
  mutate( lci.centered = pred.centered - 1.96*se,
          uci.centered = pred.centered + 1.96*se)

# Keep only variables we need

predagp.moh.ns <- predagp.moh.ns |> 
  select(pred.centered, se, lci.centered, uci.centered)

# Combine with data 

predagp.moh.ns <- predagp.moh.ns |> bind_cols(all_exp_outcome)

#  Uncenter 

predagp.moh.ns <- predagp.moh.ns |>  mutate(predagp = pred.centered + mean(ssagp),
                                        lciagp = lci.centered + mean(ssagp),
                                        uciagp = uci.centered + mean(ssagp))

# Plot

ggplot(predagp.moh.ns, aes(ssagp)) + 
  geom_line(aes(y = predagp)) + 
  geom_line(aes(y = lciagp), color = "darkgrey") + 
  geom_line(aes(y = uciagp), color = "darkgrey") + 
  xlab(expression("Average AGP")) + 
  ylab("Predicted AGP (95% CI)") + 
  theme(axis.text = element_text(size = 15)) + 
  theme(axis.title = element_text(size = 20))
```

# Linear Models 

```{r}
# Model metabolites linearly 

lin_covari_model = lm(ssagp ~ cnp + cop + ecp + ecpt + hibp + mbp + mc1 + mcoh + mep + mhbp + mhh + mhht + mhnc + mhp + mib + mnp + moh + monp + mzp + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

summary(lin_covari_model)
```


```{r}
# Individual linear models 

cnp_model <- lm(ssagp ~ cnp + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

cop_model <- lm(ssagp ~ cop + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

ecp_model <- lm(ssagp ~ ecp + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

ecpt_model <- lm(ssagp ~ ecpt + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

hibp_model <- lm(ssagp ~ hibp + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

mbp_model <- lm(ssagp ~ mbp + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

mc1_model <- lm(ssagp ~ mc1 + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

mcoh_model <- lm(ssagp ~ mcoh + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

mep_model <- lm(ssagp ~ mep + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

mhbp_model <- lm(ssagp ~ mhbp + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

mhh_model <- lm(ssagp ~ mhh + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

mhht_model <- lm(ssagp ~ mhht + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

mhnc_model <- lm(ssagp ~ mhnc + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

mhp_model <- lm(ssagp ~ mhp + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

mib_model <- lm(ssagp ~ mib + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

mnp_model <- lm(ssagp ~ mnp + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

moh_model <- lm(ssagp ~ moh + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

monp_model <- lm(ssagp ~ monp + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

mzp_model <- lm(ssagp ~ mzp + gender_female + age_yrs_screen + income_family_annual + race_ethn3, data = all_exp_outcome)

summary(mzp_model)
```

## Linear plots 

```{r}
# cnp

data_cnp <- data.frame(
  cnp = all_exp_outcome$cnp,
  gender_female = all_exp_outcome$gender_female,
  age_yrs_screen = all_exp_outcome$age_yrs_screen,
  income_family_annual = all_exp_outcome$income_family_annual,
  race_ethn3 = all_exp_outcome$race_ethn3,
  ssagp = all_exp_outcome$ssagp
)

# Predict response variable using the model
data_cnp$predicted_ssagp <- predict(cnp_model, newdata = data_cnp)

# Plot relationship between cnp and ssagp after accounting for other predictors
cnp_l <- ggplot(data_cnp, aes(x = cnp, y = ssagp)) +
  geom_point() + 
  geom_smooth(aes(y = predicted_ssagp), method = "lm", se = FALSE, color = "blue") +
  labs(x = "MCNP (g/L)", y = "AGP (ng/mL)") + 
  theme_classic()
```

```{r}
# cnp

data_cop <- data.frame(
  cop = all_exp_outcome$cop,
  gender_female = all_exp_outcome$gender_female,
  age_yrs_screen = all_exp_outcome$age_yrs_screen,
  income_family_annual = all_exp_outcome$income_family_annual,
  race_ethn3 = all_exp_outcome$race_ethn3,
  ssagp = all_exp_outcome$ssagp
)

# Predict response variable using the model
data_cop$predicted_ssagp <- predict(cop_model, newdata = data_cop)

# Plot relationship between cnp and ssagp after accounting for other predictors
cop_l <- ggplot(data_cop, aes(x = cop, y = ssagp)) +
  geom_point() + 
  geom_smooth(aes(y = predicted_ssagp), method = "lm", se = FALSE, color = "blue") +
  labs(x = "MCOP (g/L)", y = "AGP (ng/mL)") + 
  theme_classic()
```

```{r}
# ecp

data_ecp <- data.frame(
  ecp = all_exp_outcome$ecp,
  gender_female = all_exp_outcome$gender_female,
  age_yrs_screen = all_exp_outcome$age_yrs_screen,
  income_family_annual = all_exp_outcome$income_family_annual,
  race_ethn3 = all_exp_outcome$race_ethn3,
  ssagp = all_exp_outcome$ssagp
)

# Predict response variable using the model
data_ecp$predicted_ssagp <- predict(ecp_model, newdata = data_ecp)

# Plot relationship between cnp and ssagp after accounting for other predictors
ecp_l <- ggplot(data_ecp, aes(x = ecp, y = ssagp)) +
  geom_point() + 
  geom_smooth(aes(y = predicted_ssagp), method = "lm", se = FALSE, color = "blue") +
  labs(x = "MECPP (g/L)", y = "AGP (ng/mL)") + 
  theme_classic()
```


```{r}
# ecpt

data_ecpt <- data.frame(
  ecpt = all_exp_outcome$ecpt,
  gender_female = all_exp_outcome$gender_female,
  age_yrs_screen = all_exp_outcome$age_yrs_screen,
  income_family_annual = all_exp_outcome$income_family_annual,
  race_ethn3 = all_exp_outcome$race_ethn3,
  ssagp = all_exp_outcome$ssagp
)

# Predict response variable using the model
data_ecpt$predicted_ssagp <- predict(ecpt_model, newdata = data_ecpt)

# Plot relationship between cnp and ssagp after accounting for other predictors
ecpt_l <- ggplot(data_ecpt, aes(x = ecpt, y = ssagp)) +
  geom_point() + 
  geom_smooth(aes(y = predicted_ssagp), method = "lm", se = FALSE, color = "blue") +
  labs(x = "MECPTP (g/L)", y = "AGP (ng/mL)") +
  theme_classic()
```

```{r}
# hibp

data_hibp <- data.frame(
  hibp = all_exp_outcome$hibp,
  gender_female = all_exp_outcome$gender_female,
  age_yrs_screen = all_exp_outcome$age_yrs_screen,
  income_family_annual = all_exp_outcome$income_family_annual,
  race_ethn3 = all_exp_outcome$race_ethn3,
  ssagp = all_exp_outcome$ssagp
)

# Predict response variable using the model
data_hibp$predicted_ssagp <- predict(hibp_model, newdata = data_hibp)

# Plot relationship between cnp and ssagp after accounting for other predictors
hibp_l <- ggplot(data_hibp, aes(x = hibp, y = ssagp)) +
  geom_point() + 
  geom_smooth(aes(y = predicted_ssagp), method = "lm", se = FALSE, color = "blue") +
  labs(x = "HiBP (g/L)", y = "AGP (ng/mL)") + 
  theme_classic()
```

```{r}
# mbp


data_mbp <- data.frame(
  mbp = all_exp_outcome$mbp,
  gender_female = all_exp_outcome$gender_female,
  age_yrs_screen = all_exp_outcome$age_yrs_screen,
  income_family_annual = all_exp_outcome$income_family_annual,
  race_ethn3 = all_exp_outcome$race_ethn3,
  ssagp = all_exp_outcome$ssagp
)

# Predict response variable using the model
data_mbp$predicted_ssagp <- predict(mbp_model, newdata = data_mbp)

# Plot relationship between cnp and ssagp after accounting for other predictors
mbp_l <- ggplot(data_mbp, aes(x = mbp, y = ssagp)) +
  geom_point() + 
  geom_smooth(aes(y = predicted_ssagp), method = "lm", se = FALSE, color = "blue") +
  labs(x = "MiBP (g/L)", y = "AGP (ng/mL)") + 
  theme_classic()
```


```{r}
# mc1

data_mc1 <- data.frame(
  mc1 = all_exp_outcome$mc1,
  gender_female = all_exp_outcome$gender_female,
  age_yrs_screen = all_exp_outcome$age_yrs_screen,
  income_family_annual = all_exp_outcome$income_family_annual,
  race_ethn3 = all_exp_outcome$race_ethn3,
  ssagp = all_exp_outcome$ssagp
)

# Predict response variable using the model
data_mc1$predicted_ssagp <- predict(mc1_model, newdata = data_mc1)

# Plot relationship between cnp and ssagp after accounting for other predictors
mc1_l <- ggplot(data_mc1, aes(x = mc1, y = ssagp)) +
  geom_point() + 
  geom_smooth(aes(y = predicted_ssagp), method = "lm", se = FALSE, color = "blue") +
  labs(x = "MCPP (g/L)", y = "AGP (ng/mL)", title = "MC1") + 
  theme_classic()
```

```{r}
# mcoh

data_mcoh <- data.frame(
  mcoh = all_exp_outcome$mcoh,
  gender_female = all_exp_outcome$gender_female,
  age_yrs_screen = all_exp_outcome$age_yrs_screen,
  income_family_annual = all_exp_outcome$income_family_annual,
  race_ethn3 = all_exp_outcome$race_ethn3,
  ssagp = all_exp_outcome$ssagp
)

# Predict response variable using the model
data_mcoh$predicted_ssagp <- predict(mcoh_model, newdata = data_mcoh)

# Plot relationship between cnp and ssagp after accounting for other predictors
mcoh_l <- ggplot(data_mcoh, aes(x = mcoh, y = ssagp)) +
  geom_point() + 
  geom_smooth(aes(y = predicted_ssagp), method = "lm", se = FALSE, color = "blue") +
  labs(x = "MCOCH (g/L)", y = "AGP (ng/mL)") + 
  theme_classic()
```


```{r}
# mep

data_mep <- data.frame(
  mep = all_exp_outcome$mep,
  gender_female = all_exp_outcome$gender_female,
  age_yrs_screen = all_exp_outcome$age_yrs_screen,
  income_family_annual = all_exp_outcome$income_family_annual,
  race_ethn3 = all_exp_outcome$race_ethn3,
  ssagp = all_exp_outcome$ssagp
)

# Predict response variable using the model
data_mep$predicted_ssagp <- predict(mep_model, newdata = data_mep)

# Plot relationship between cnp and ssagp after accounting for other predictors
mep_l <- ggplot(data_mep, aes(x = mep, y = ssagp)) +
  geom_point() + 
  geom_smooth(aes(y = predicted_ssagp), method = "lm", se = FALSE, color = "blue") +
  labs(x = "MEP (g/L)", y = "AGP (ng/mL)") + 
  theme_classic() 
```


```{r}
# mhbp

data_mhbp <- data.frame(
  mhbp = all_exp_outcome$mhbp,
  gender_female = all_exp_outcome$gender_female,
  age_yrs_screen = all_exp_outcome$age_yrs_screen,
  income_family_annual = all_exp_outcome$income_family_annual,
  race_ethn3 = all_exp_outcome$race_ethn3,
  ssagp = all_exp_outcome$ssagp
)

# Predict response variable using the model
data_mhbp$predicted_ssagp <- predict(mhbp_model, newdata = data_mhbp)

# Plot relationship between cnp and ssagp after accounting for other predictors
mhbp_l <- ggplot(data_mhbp, aes(x = mhbp, y = ssagp)) +
  geom_point() + 
  geom_smooth(aes(y = predicted_ssagp), method = "lm", se = FALSE, color = "blue") +
  labs(x = "MnBP (g/L)", y = "AGP (ng/mL)") + 
  theme_classic()
```

```{r}
# mhh

data_mhh <- data.frame(
  mhh = all_exp_outcome$mhh,
  gender_female = all_exp_outcome$gender_female,
  age_yrs_screen = all_exp_outcome$age_yrs_screen,
  income_family_annual = all_exp_outcome$income_family_annual,
  race_ethn3 = all_exp_outcome$race_ethn3,
  ssagp = all_exp_outcome$ssagp
)

# Predict response variable using the model
data_mhh$predicted_ssagp <- predict(mhh_model, newdata = data_mhh)

# Plot relationship between cnp and ssagp after accounting for other predictors
mhh_l <- ggplot(data_mhh, aes(x = mhh, y = ssagp)) +
  geom_point() + 
  geom_smooth(aes(y = predicted_ssagp), method = "lm", se = FALSE, color = "blue") +
  labs(x = "MEHHP (g/L)", y = "AGP (ng/mL)") + 
  theme_classic()
```

```{r}
# mhht

data_mhht <- data.frame(
  mhht = all_exp_outcome$mhht,
  gender_female = all_exp_outcome$gender_female,
  age_yrs_screen = all_exp_outcome$age_yrs_screen,
  income_family_annual = all_exp_outcome$income_family_annual,
  race_ethn3 = all_exp_outcome$race_ethn3,
  ssagp = all_exp_outcome$ssagp
)

# Predict response variable using the model
data_mhht$predicted_ssagp <- predict(mhht_model, newdata = data_mhht)

# Plot relationship between cnp and ssagp after accounting for other predictors
mhht_l <- ggplot(data_mhht, aes(x = mhht, y = ssagp)) +
  geom_point() + 
  geom_smooth(aes(y = predicted_ssagp), method = "lm", se = FALSE, color = "blue") +
  labs(x = "MEHHTP (g/L)", y = "AGP (ng/mL)") +
  theme_classic()
```

```{r}
# mhnc

data_mhnc <- data.frame(
  mhnc = all_exp_outcome$mhnc,
  gender_female = all_exp_outcome$gender_female,
  age_yrs_screen = all_exp_outcome$age_yrs_screen,
  income_family_annual = all_exp_outcome$income_family_annual,
  race_ethn3 = all_exp_outcome$race_ethn3,
  ssagp = all_exp_outcome$ssagp
)

# Predict response variable using the model
data_mhnc$predicted_ssagp <- predict(mhnc_model, newdata = data_mhnc)

# Plot relationship between cnp and ssagp after accounting for other predictors
mhnc_l <- ggplot(data_mhnc, aes(x = mhnc, y = ssagp)) +
  geom_point() + 
  geom_smooth(aes(y = predicted_ssagp), method = "lm", se = FALSE, color = "blue") +
  labs(x = "MHNCH (g/L)", y = "AGP (ng/mL)") + 
  theme_classic()
```

```{r}
# mhp

data_mhp <- data.frame(
  mhp = all_exp_outcome$mhp,
  gender_female = all_exp_outcome$gender_female,
  age_yrs_screen = all_exp_outcome$age_yrs_screen,
  income_family_annual = all_exp_outcome$income_family_annual,
  race_ethn3 = all_exp_outcome$race_ethn3,
  ssagp = all_exp_outcome$ssagp
)

# Predict response variable using the model
data_mhp$predicted_ssagp <- predict(mhp_model, newdata = data_mhp)

# Plot relationship between cnp and ssagp after accounting for other predictors
mhp_l <- ggplot(data_mhp, aes(x = mhp, y = ssagp)) +
  geom_point() + 
  geom_smooth(aes(y = predicted_ssagp), method = "lm", se = FALSE, color = "blue") +
  labs(x = "MEHP (g/L)", y = "AGP (ng/mL)") + 
  theme_classic()
```

```{r}
# mib

data_mib <- data.frame(
  mib = all_exp_outcome$mib,
  gender_female = all_exp_outcome$gender_female,
  age_yrs_screen = all_exp_outcome$age_yrs_screen,
  income_family_annual = all_exp_outcome$income_family_annual,
  race_ethn3 = all_exp_outcome$race_ethn3,
  ssagp = all_exp_outcome$ssagp
)

# Predict response variable using the model
data_mib$predicted_ssagp <- predict(mib_model, newdata = data_mib)

# Plot relationship between cnp and ssagp after accounting for other predictors
mib_l <- ggplot(data_mib, aes(x = mib, y = ssagp)) +
  geom_point() + 
  geom_smooth(aes(y = predicted_ssagp), method = "lm", se = FALSE, color = "blue") +
  labs(x = "MiBP (g/L)", y = "AGP (ng/mL)") + 
  theme_classic()
```

```{r}
# mnp

data_mnp <- data.frame(
  mnp = all_exp_outcome$mnp,
  gender_female = all_exp_outcome$gender_female,
  age_yrs_screen = all_exp_outcome$age_yrs_screen,
  income_family_annual = all_exp_outcome$income_family_annual,
  race_ethn3 = all_exp_outcome$race_ethn3,
  ssagp = all_exp_outcome$ssagp
)

# Predict response variable using the model
data_mnp$predicted_ssagp <- predict(mnp_model, newdata = data_mnp)

# Plot relationship between cnp and ssagp after accounting for other predictors
mnp_l <- ggplot(data_mnp, aes(x = mnp, y = ssagp)) +
  geom_point() + 
  geom_smooth(aes(y = predicted_ssagp), method = "lm", se = FALSE, color = "blue") +
  labs(x = "MiNP (g/L)", y = "AGP (ng/mL)") + 
  theme_classic()
```

```{r}
# moh

data_moh <- data.frame(
  moh = all_exp_outcome$moh,
  gender_female = all_exp_outcome$gender_female,
  age_yrs_screen = all_exp_outcome$age_yrs_screen,
  income_family_annual = all_exp_outcome$income_family_annual,
  race_ethn3 = all_exp_outcome$race_ethn3,
  ssagp = all_exp_outcome$ssagp
)

# Predict response variable using the model
data_moh$predicted_ssagp <- predict(moh_model, newdata = data_moh)

# Plot relationship between cnp and ssagp after accounting for other predictors
moh_l <- ggplot(data_moh, aes(x = moh, y = ssagp)) +
  geom_point() + 
  geom_smooth(aes(y = predicted_ssagp), method = "lm", se = FALSE, color = "blue") +
  labs(x = "MEOHP (g/L)", y = "AGP (ng/mL)") + 
  theme_classic()
```

```{r}
# monp

data_monp <- data.frame(
  monp = all_exp_outcome$monp,
  gender_female = all_exp_outcome$gender_female,
  age_yrs_screen = all_exp_outcome$age_yrs_screen,
  income_family_annual = all_exp_outcome$income_family_annual,
  race_ethn3 = all_exp_outcome$race_ethn3,
  ssagp = all_exp_outcome$ssagp
)

# Predict response variable using the model
data_monp$predicted_ssagp <- predict(monp_model, newdata = data_monp)

# Plot relationship between cnp and ssagp after accounting for other predictors
monp_l <- ggplot(data_monp, aes(x = monp, y = ssagp)) +
  geom_point() + 
  geom_smooth(aes(y = predicted_ssagp), method = "lm", se = FALSE, color = "blue") +
  labs(x = "MONP (g/L)", y = "AGP (ng/mL)") + 
  theme_classic()
```

```{r}
# mzp

data_mzp <- data.frame(
  mzp = all_exp_outcome$mzp,
  gender_female = all_exp_outcome$gender_female,
  age_yrs_screen = all_exp_outcome$age_yrs_screen,
  income_family_annual = all_exp_outcome$income_family_annual,
  race_ethn3 = all_exp_outcome$race_ethn3,
  ssagp = all_exp_outcome$ssagp
)

# Predict response variable using the model
data_mzp$predicted_ssagp <- predict(mzp_model, newdata = data_mzp)

# Plot relationship between cnp and ssagp after accounting for other predictors
mzp_l <- ggplot(data_mzp, aes(x = mzp, y = ssagp)) +
  geom_point() + 
  geom_smooth(aes(y = predicted_ssagp), method = "lm", se = FALSE, color = "blue") +
  labs(x = "MBzP (g/L)", y = "AGP (ng/mL)") + 
  theme_classic()
```

```{r message=FALSE, warning=FALSE}
#Combine all plots

linear_plots_combined <- grid.arrange(cnp_l, cop_l, ecp_l, ecpt_l, hibp_l, mbp_l, mc1_l, mcoh_l, mep_l, mhbp_l, mhh_l, mhht_l, mhnc_l, mhp_l, mib_l, mnp_l, moh_l, monp_l, mzp_l, ncol = 4, top = "Linear Models of Metabolite Exposure-Response Curves")

#save plot as png
ggsave("linear_plots_combined.png", linear_plots_combined, width = 30, height = 25, units = "cm")

```


```{r}
# PCA Attempt (will add FA)

# PCA first attempt, will improve after PCA/FA class

metabolites_ids_orig <- phthte_creatinine %>%
  na.omit() %>% 
  pivot_wider(id_cols = seqn,
              names_from = analyte_code,
              values_from = adj_conc)
combined <- inner_join(metabolites_ids_orig, agp_serum, by = "seqn")

metabolites_ids_rownames <- metabolites_ids_orig %>% 
  column_to_rownames("seqn") 

library(Hmisc)

pca <- princmp(metabolites_ids_rownames)
#plot(pca, k = 2)


pca_result <- prcomp(metabolites_ids_rownames, scale. = TRUE)
summary(pca_result)
biplot(pca_result)

# Convert PCA results to a data frame
df_pca <- as.data.frame(pca_result$x)

subj_ids_pca <- df_pca %>% 
  rownames_to_column(var = "seqn") %>% 
  mutate(seqn = as.numeric(seqn))

mat_ssagp <- left_join(subj_ids_pca, agp_serum %>% select(seqn, ssagp), by = "seqn")

# Add the agp information
df_pca$AGP <- mat_ssagp$ssagp  

df_pca2 <- df_pca %>% 
  na.omit()


library(ggplot2)

ggplot(df_pca2, aes(x = PC1, y = PC2, color = AGP)) +
  geom_point() +
  xlim(c(-2.5,5)) +
  ylim(c(-5, 15)) +
  xlab("Principal Component 1") +
  ylab("Principal Component 2") +
  ggtitle("PCA of Metabolites Colored by AGP Level") +
  theme_minimal() 

ggplot(df_pca2, aes(x = PC3, y = PC2, color = AGP)) +
  geom_point() +
  xlim(c(-2.5,5)) +
  ylim(c(-5, 15)) +
  xlab("Principal Component 3") +
  ylab("Principal Component 2") +
  ggtitle("PCA of Metabolites Colored by AGP Level") +
  theme_minimal() 

# df_pca2

plot(pca_result)

loadings <- pca_result$rotation
print(loadings[,1:6])

library(pheatmap)
pheatmap(loadings[,1:8], cluster_cols = F, main = "Heatmap of PCs and Metabolites")

```

The main metabolites for the first principal component are mhh, moh, ecp, and mhcp. The main metabolites for the second PC are monp, cop, and mnp. The main metabolites for the third PC are mbp, mhbp, mib, and hibp.